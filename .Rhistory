x
}
seq_ids_clean <- clean_names(seq_ids)
traits$Taxon <- clean_names(traits$Taxon)
# -- examine overlap --
cat("Unique taxa in traits:", length(unique(traits$Taxon)), "\n")
cat("Unique cleaned seq IDs:", length(unique(seq_ids_clean)), "\n")
n_match <- sum(seq_ids_clean %in% traits$Taxon)
cat("Number of seq IDs that match a Taxon:", n_match, "\n")
# show which seq ids do not match (first 20)
unmatched <- setdiff(seq_ids_clean, traits$Taxon)
if (length(unmatched) > 0) {
cat("Unmatched sequence IDs (first 20):\n")
print(unmatched[1:min(length(unmatched),20)])
} else {
cat("All sequence IDs matched taxa.\n")
}
# -- now create pop aligned to sequence order --
pop_vec <- traits$Population[match(seq_ids_clean, traits$Taxon)]
# If any NA present, report them and stop before haploFreq
if (any(is.na(pop_vec))) {
cat("ERROR: some sequences did not get a population assignment (NA in pop_vec).\n")
missing_idx <- which(is.na(pop_vec))
cat("First few missing sequence IDs:\n")
print(seq_ids[missing_idx[1:min(length(missing_idx),20)]])
stop("Fix the unmatched sample names in your CSV or adjust cleaning rules, then retry.")
}
dna <- read.nexus.data("/Users/henrysun_1/Desktop/Duke/PhD 2025-2026/callinectes_co1/processed/combined_unique_trimmed.nexus")
traits <- read.csv("/Users/henrysun_1/Desktop/Duke/PhD 2025-2026/callinectes_co1/processed/population_traits.csv", stringsAsFactors = FALSE)
traits
dna_bin <- as.DNAbin(dna)
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
hap_freq <- haploFreq(dna_bin, fac = pop, haplo = haps)
if (is.matrix(dna_bin) || is.data.frame(dna_bin)) {
seq_ids <- rownames(dna_bin)
} else {
seq_ids <- names(dna_bin)
}
# Quick check
cat("Number of sequences:", length(seq_ids), "\n")
head(seq_ids, 10)
# -- check traits columns --
cat("Traits columns:", paste(colnames(traits), collapse = ", "), "\n")
head(traits, 6)
# -- same cleaning function as before --
clean_names <- function(x) {
x <- trimws(as.character(x))
x <- gsub("^>", "", x)             # drop leading '>'
x <- gsub("\\..*$", "", x)         # drop trailing extensions
x <- gsub("[^A-Za-z0-9_\\-]", "", x)  # keep alphanumeric,_,-
x
}
seq_ids_clean <- clean_names(seq_ids)
traits$Taxon <- clean_names(traits$Taxon)
# -- examine overlap --
cat("Unique taxa in traits:", length(unique(traits$Taxon)), "\n")
cat("Unique cleaned seq IDs:", length(unique(seq_ids_clean)), "\n")
n_match <- sum(seq_ids_clean %in% traits$Taxon)
cat("Number of seq IDs that match a Taxon:", n_match, "\n")
# show which seq ids do not match (first 20)
unmatched <- setdiff(seq_ids_clean, traits$Taxon)
if (length(unmatched) > 0) {
cat("Unmatched sequence IDs (first 20):\n")
print(unmatched[1:min(length(unmatched),20)])
} else {
cat("All sequence IDs matched taxa.\n")
}
# -- now create pop aligned to sequence order --
pop_vec <- traits$Population[match(seq_ids_clean, traits$Taxon)]
# If any NA present, report them and stop before haploFreq
if (any(is.na(pop_vec))) {
cat("ERROR: some sequences did not get a population assignment (NA in pop_vec).\n")
missing_idx <- which(is.na(pop_vec))
cat("First few missing sequence IDs:\n")
print(seq_ids[missing_idx[1:min(length(missing_idx),20)]])
stop("Fix the unmatched sample names in your CSV or adjust cleaning rules, then retry.")
}
library(pegas)
library(knitr)
library(ape)
library(tidyverse)
setwd("/Users/henrysun_1/Desktop/Duke/PhD 2025-2026/callinectes_co1")
getwd()
dna <- read.nexus.data("/Users/henrysun_1/Desktop/Duke/PhD 2025-2026/callinectes_co1/processed/combined_unique_trimmed.nexus")
traits <- read.csv("/Users/henrysun_1/Desktop/Duke/PhD 2025-2026/callinectes_co1/processed/population_traits.csv", stringsAsFactors = FALSE)
dna_bin <- as.DNAbin(dna)
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
hap_freq <- haploFreq(dna_bin, fac = pop, haplo = haps)
if (is.matrix(dna_bin) || is.data.frame(dna_bin)) {
seq_ids <- rownames(dna_bin)
} else {
seq_ids <- names(dna_bin)
}
# Quick check
cat("Number of sequences:", length(seq_ids), "\n")
head(seq_ids, 10)
# -- check traits columns --
cat("Traits columns:", paste(colnames(traits), collapse = ", "), "\n")
head(traits, 6)
# -- same cleaning function as before --
clean_names <- function(x) {
x <- trimws(as.character(x))
x <- gsub("^>", "", x)             # drop leading '>'
x <- gsub("\\..*$", "", x)         # drop trailing extensions
x <- gsub("[^A-Za-z0-9_\\-]", "", x)  # keep alphanumeric,_,-
x
}
seq_ids_clean <- clean_names(seq_ids)
traits$Taxon <- clean_names(traits$Taxon)
# -- examine overlap --
cat("Unique taxa in traits:", length(unique(traits$Taxon)), "\n")
cat("Unique cleaned seq IDs:", length(unique(seq_ids_clean)), "\n")
n_match <- sum(seq_ids_clean %in% traits$Taxon)
cat("Number of seq IDs that match a Taxon:", n_match, "\n")
# show which seq ids do not match (first 20)
unmatched <- setdiff(seq_ids_clean, traits$Taxon)
if (length(unmatched) > 0) {
cat("Unmatched sequence IDs (first 20):\n")
print(unmatched[1:min(length(unmatched),20)])
} else {
cat("All sequence IDs matched taxa.\n")
}
# -- now create pop aligned to sequence order --
pop_vec <- traits$Population[match(seq_ids_clean, traits$Taxon)]
# If any NA present, report them and stop before haploFreq
if (any(is.na(pop_vec))) {
cat("ERROR: some sequences did not get a population assignment (NA in pop_vec).\n")
missing_idx <- which(is.na(pop_vec))
cat("First few missing sequence IDs:\n")
print(seq_ids[missing_idx[1:min(length(missing_idx),20)]])
stop("Fix the unmatched sample names in your CSV or adjust cleaning rules, then retry.")
}
# convert to factor and check length
pop <- factor(pop_vec)
cat("Length of pop:", length(pop), "  Number of sequences:", length(seq_ids), "\n")
print(table(pop))
# -- continue pipeline --
# compute haplotype frequencies (fac must be length = # sequences)
hap_freq <- haploFreq(dna_bin, fac = pop, haplo = haps)
fac
pop
if (is.matrix(dna_bin)) {
ids <- rownames(dna_bin)
} else {
ids <- names(dna_bin)
}
length(ids)
head(ids)
clean_names <- function(x) {
x <- trimws(x)
x <- gsub("^>", "", x)
x <- gsub("\\..*$", "", x)
x <- gsub("[^A-Za-z0-9_\\-]", "", x)
return(x)
}
# Extract sequence IDs correctly
if (is.matrix(dna_bin)) {
seq_ids <- rownames(dna_bin)
} else {
seq_ids <- names(dna_bin)
}
seq_ids <- clean_names(seq_ids)
traits$Taxon <- clean_names(traits$Taxon)
# Match populations to the sequences
pop_vec <- traits$Population[match(seq_ids, traits$Taxon)]
# Check for missing matches
sum(is.na(pop_vec))
head(pop_vec)
setdiff(seq_ids, traits$Taxon)
pop <- factor(pop_vec)
pop <- factor(pop_vec)
table(pop)
pop <- factor(pop_vec)
table(pop)
hap_freq <- haploFreq(dna_bin, fac = pop, haplo = haps)
View(dna_bin)
head(seq_ids)
head(traits$Taxon)
dna_bin <- as.DNAbin(dna)
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
traits$Taxon
dna_bin
seq_ids
# Clean and align names again (you already have this)
clean_names <- function(x) {
x <- trimws(x)
x <- gsub("^>", "", x)
x <- gsub("\\..*$", "", x)
x <- gsub("[^A-Za-z0-9_\\-]", "", x)
return(x)
}
# 1. Extract sequence IDs
if (is.matrix(dna_bin)) {
seq_ids <- rownames(dna_bin)
} else {
seq_ids <- names(dna_bin)
}
seq_ids <- clean_names(seq_ids)
traits$Taxon <- clean_names(traits$Taxon)
# 2. Check alignment directly
m <- match(seq_ids, traits$Taxon)
sum(is.na(m))         # should be 0
which(is.na(m))       # show which if any NA
all(seq_ids %in% traits$Taxon)  # should be TRUE
# 3. Look at mismatches if any
if (any(is.na(m))) {
cat("Mismatched sequence IDs:\n")
print(seq_ids[is.na(m)])
}
# 4. If all match, safely create pop factor
pop <- factor(traits$Population[m])
# 5. Verify same length as sequences and populations present
length(pop)
table(pop)
# 6. Proceed to haplotype frequencies
hap_freq <- haploFreq(dna_bin, fac = pop, haplo = haps)
class(dna_bin)
dna_mat <- as.matrix(dna_bin)
# Confirm it's a DNAbin matrix
class(dna_mat)
pop
haps
?plot.haploNet
dna_bin <- as.DNAbin(dna)
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- traits$Population[match(names(dna_bin), traits$Taxon
table(pop)  # check that populations are assigned correctly
dna_bin <- as.DNAbin(dna)
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- traits$Population[match(names(dna_bin), traits$Taxon)]
table(pop)  # check that populations are assigned correctly
(R <- haploFreq(dna_bin, fac = pop, haplo = haps))
nrow(dna_bin)
?haploFreq
dna_bin <- as.DNAbin(dna)
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- traits$Population[match(names(dna_bin), traits$Taxon)]
table(pop)  # check that populations are assigned correctly
(R <- haploFreq(dna_bin, haplo = haps))
View(dna)
dna <- read.nexus.data("/Users/henrysun_1/Desktop/Duke/PhD 2025-2026/callinectes_co1/processed/combined_unique_trimmed.nexus")
traits <- read.csv("/Users/henrysun_1/Desktop/Duke/PhD 2025-2026/callinectes_co1/processed/population_traits.csv")
View(traits)
dna_bin <- as.DNAbin(dna)
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- traits$Population[match(names(dna_bin), traits$Taxon)]
table(pop)  # check that populations are assigned correctly
R <- haploFreq(dna_bin, haplo = haps)
dna_bin <- as.DNAbin(dna)
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- as.factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
R <- haploFreq(dna_bin, haplo = haps)
dna_bin <- as.DNAbin(dna)
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- as.factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
dna_bin <- as.DNAbin(dna)
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- as.factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
R <- haploFreq(dna_bin, fac=pop, haplo = haps)
nrow(dna_bin)
dna_bin <- as.DNAbin(dna)
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- as.factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
R <- haploFreq(dna, fac=pop, haplo = haps)
length(fac)
length(pop)
nrow(dna_bin)
dna_mat <- as.DNAbin(as.alignment(as.list(dna_bin)))
nrow(dna_mat)
dna_bin <- as.DNAbin(dna)
dna_mat <- as.DNAbin(as.alignment(as.list(dna_bin)))
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- as.factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
R <- haploFreq(dna, fac=pop, haplo = haps)
class(dna_mat)
nrow(dna_mat)
length(pop)
dna_bin <- as.DNAbin(dna)
dna_mat <- as.DNAbin(as.alignment(as.list(dna_bin)))
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- as.factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
R <- haploFreq(dna_mat, fac=pop, haplo = haps)
R
dna_bin <- as.DNAbin(dna)
dna_mat <- as.DNAbin(as.alignment(as.list(dna_bin)))
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- as.factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
hap_freq <- haploFreq(dna_mat, fac=pop, haplo = haps)
hap_freq <- hap_freq[attr(net, "labels"), ]
dna_bin <- as.DNAbin(dna)
dna_mat <- as.DNAbin(as.alignment(as.list(dna_bin)))
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- as.factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
hap_freq <- haploFreq(dna_mat, fac=pop, haplo = haps)
hap_freq <- hap_freq[attr(net, "labels"), ]
hap_freq
setHaploNetOptions(labels = FALSE)
plot(net, pie = hap_freq, legend = TRUE, threshold = c(1, 20))
rownames(hap_freq)
attr(net, "labels")
setdiff(attr(net, "labels"), rownames(hap_freq))
sum(is.na(hap_freq))
sum(!is.finite(hap_freq))
hap_freq <- apply(hap_freq, 2, as.numeric)
hap_freq
hap_freq <- hap_freq[net.labs, ]
dna_bin <- as.DNAbin(dna)
dna_mat <- as.DNAbin(as.alignment(as.list(dna_bin)))
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- as.factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
hap_freq <- haploFreq(dna_mat, fac=pop, haplo = haps)
hap_freq <- hap_freq[attr(net, "labels"), ]
hap_freq
hap_freq <- hap_freq[net.labs, ]
View(hap_freq)
hap_freq <- hap_freq[net.labs, ]
sz <- summary(haps)
plot(nt, size = sz, pie = hap_freq, legend = c(-25, 30))
hap_freq <- hap_freq[net.labs, ]
sz <- summary(haps)
plot(net, size = sz, pie = hap_freq, legend = c(-25, 30))
hap_freq <- hap_freq[net.labs, ]
plot(net, pie = hap_freq, legend = c(-25, 30))
dna_bin <- as.DNAbin(dna)
dna_mat <- as.DNAbin(as.alignment(as.list(dna_bin)))
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- as.factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
hap_freq <- haploFreq(dna_mat, fac=pop, haplo = haps)
hap_freq <- hap_freq[attr(net, "labels"), ]
hap_freq <- hap_freq[net.labs, ]
hap_freq
setdiff(attr(net, "labels"), rownames(hap_freq))
str(hap_freq)
summary(hap_freq)
# 2️⃣ Force numeric and replace missing values
hap_freq <- apply(hap_freq, 2, function(col) as.numeric(col))
hap_freq[is.na(hap_freq)] <- 0
hap_freq[!is.finite(hap_freq)] <- 0
# restore row names (lost by apply)
rownames(hap_freq) <- attr(net, "labels")
# 3️⃣ Sanity check
all(rownames(hap_freq) == attr(net, "labels"))
sum(is.na(hap_freq))
sum(!is.finite(hap_freq))
setHaploNetOptions(labels = FALSE)
plot(net, pie = hap_freq, legend = c(-25, 25), threshold = c(1, 20))
library(pegas)
library(knitr)
library(ape)
library(tidyverse)
library(RColorBrewer)
setwd("/Users/henrysun_1/Desktop/Duke/PhD 2025-2026/callinectes_co1")
getwd()
hap_summary <- summary(haps)                     # counts per haplotype
hap_sizes <- hap_summary[attr(net, "labels")]    # reorder to match network
## 2️⃣  Choose a color palette for populations
n_pop <- ncol(hap_freq)
pop_colors <- brewer.pal(min(n_pop, 8), "Set2")  # up to 8 nice colors
## 3️⃣  Force numeric pies and clean up
hap_freq <- apply(hap_freq, 2, as.numeric)
rownames(hap_freq) <- attr(net, "labels")
## 4️⃣  Remove labels and plot
setHaploNetOptions(labels = FALSE)
plot(
net,
size = hap_sizes,                # scale by haplotype frequency
pie = hap_freq,                  # population proportions per haplotype
legend = c(-25, 25),             # position of legend (x, y coords)
threshold = c(1, 20),
bg = "white"
)
View(hap_freq)
setHaploNetOptions(labels = FALSE)
plot(net, pie = hap_freq, legend = c(-25, 30))
setHaploNetOptions(labels = FALSE)
plot(net, pie = hap_freq, legend = TRUE)
hap_freq
setHaploNetOptions(labels = FALSE)
plot(net, pie = hap_freq)
setHaploNetOptions(labels = FALSE)
plot(net, legend=TRUE)
View(hap_freq)
# setHaploNetOptions(labels = FALSE)
plot(net, pie = hap_freq, legend=TRUE)
hap_summary <- summary(haps)
hap_sizes <- hap_summary[attr(net, "labels")]
hap_sizes
hap_summary <- summary(haps)                     # counts per haplotype
hap_sizes <- hap_summary[attr(net, "labels")]    # reorder to match networ
ncol(hap_freq)
# setHaploNetOptions(labels = FALSE)
hap_summary <- summary(haps)
hap_sizes <- hap_summary[attr(net, "labels")]
n_pop <- ncol(hap_freq)
pop_colors <- brewer.pal(min(n_pop, 8), "Set2")
hap_freq <- apply(hap_freq, 2, as.numeric)
rownames(hap_freq) <- attr(net, "labels")
plot(
net,
size = sqrt(hap_sizes),                # scale by haplotype frequency
pie = hap_freq,                  # population proportions per haplotype
legend = TRUE,
threshold = c(1, 20),
bg = "white"
)
# setHaploNetOptions(labels = FALSE)
hap_summary <- summary(haps)
hap_sizes <- hap_summary[attr(net, "labels")]
n_pop <- ncol(hap_freq)
pop_colors <- brewer.pal(min(n_pop, 8), "Set2")
hap_freq <- apply(hap_freq, 2, as.numeric)
rownames(hap_freq) <- attr(net, "labels")
plot(
net,
size = sqrt(2*hap_sizes),                # scale by haplotype frequency
pie = hap_freq,                  # population proportions per haplotype
legend = TRUE,
threshold = c(1, 20),
bg = "white"
)
?haploPlot
?plot.haplotype
?plot.haploNet
?plot
hap_summary
hap_sizes
dna_bin <- as.DNAbin(dna)
dna_mat <- as.DNAbin(as.alignment(as.list(dna_bin)))
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- as.factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
hap_freq <- haploFreq(dna_mat, fac=pop, haplo = haps)
hap_freq <- hap_freq[attr(net, "labels"), ]
# hap_freq <- hap_freq[net.labs, ]
hap_freq
dna_bin <- as.DNAbin(dna)
dna_mat <- as.DNAbin(as.alignment(as.list(dna_bin)))
haps <- haplotype(dna_bin)
d <- dist.dna(haps, "N")
net <- rmst(d, quiet = TRUE)
pop <- as.factor(traits$Population[match(names(dna_bin), traits$Taxon)])
table(pop)  # check that populations are assigned correctly
hap_freq <- haploFreq(dna_mat, fac=pop, haplo = haps)
# hap_freq <- hap_freq[attr(net, "labels"), ]
# hap_freq <- hap_freq[net.labs, ]
hap_freq
# setHaploNetOptions(labels = FALSE)
# hap_summary <- summary(haps)
# hap_sizes <- hap_summary[attr(net, "labels")]
n_pop <- ncol(hap_freq)
pop_colors <- brewer.pal(min(n_pop, 8), "Set2")
# hap_freq <- apply(hap_freq, 2, as.numeric)
# rownames(hap_freq) <- attr(net, "labels")
plot(
net,
size = sqrt(2*hap_sizes),
pie = hap_freq,
legend = TRUE,
threshold = c(1, 20),
)
